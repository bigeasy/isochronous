<!DOCTYPE html>

<html>
<head>
  <title>isochronous.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>isochronous.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)
<span class="hljs-keyword">var</span> Operation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'operation/variadic'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO Feel like there should be an option to have regular intervals that you
try to hit, which means skipping them if you’ve taken too long, and
alternatively an interval between completion.</p>

            </div>

            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Isochronous</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">this</span>._operation = <span class="hljs-keyword">new</span> Operation(vargs)
    <span class="hljs-keyword">var</span> options = coalesce(vargs.shift(), {})
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options == <span class="hljs-string">'number'</span>) {
        options = { <span class="hljs-attr">interval</span>: options }
    }
    <span class="hljs-keyword">this</span>._interval = coalesce(options.interval, <span class="hljs-number">1000</span>)
    <span class="hljs-keyword">this</span>._unref = coalesce(options.unref, <span class="hljs-literal">false</span>)
</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO remove underbars, this is a public feature.
TODO It is‽</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._setTimeout = coalesce(options._setTimeout, setTimeout)
    <span class="hljs-keyword">this</span>._Date = coalesce(options._Date, <span class="hljs-built_in">Date</span>)
}

Isochronous.prototype._wait = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stats, now, callback</span>) </span>{
    <span class="hljs-keyword">var</span> delay = stats.scheduled - now
    <span class="hljs-keyword">if</span> (stats.overflow = delay &lt; <span class="hljs-number">0</span>) {
        delay = <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">this</span>._timeout = <span class="hljs-keyword">this</span>._setTimeout.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>._callback = callback, delay)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._unref &amp;&amp; delay != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>._timeout.unref()
    }
}

Isochronous.prototype.run = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">this</span>._stop = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">var</span> now = (<span class="hljs-keyword">this</span>._Date).now()
    <span class="hljs-keyword">var</span> stats = <span class="hljs-keyword">this</span>.stats = {
        <span class="hljs-attr">scheduled</span>: (<span class="hljs-built_in">Math</span>.floor(now / <span class="hljs-number">1000</span>) * <span class="hljs-number">1000</span>),
        <span class="hljs-attr">start</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">overflow</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">iteration</span>: <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._wait(stats, now, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancel</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stop) {
                <span class="hljs-keyword">return</span> [ loop.break ]
            }
        }
        <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>._callback = <span class="hljs-literal">null</span>
        }, cancel, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            stats.start = (<span class="hljs-keyword">this</span>._Date).now()
            <span class="hljs-keyword">this</span>._operation.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">async</span>())
        }, cancel, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            stats.iteration++

            <span class="hljs-keyword">var</span> now = (<span class="hljs-keyword">this</span>._Date).now()

            stats.duration = now - stats.start
</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO Need to advance if updated scheudled is in the past.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            stats.scheduled = stats.scheduled + <span class="hljs-keyword">this</span>._interval

            <span class="hljs-keyword">this</span>._wait(stats, now, <span class="hljs-keyword">async</span>())
        })()
    })
})

Isochronous.prototype.stop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._stop = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> callback
    <span class="hljs-keyword">if</span> (callback = <span class="hljs-keyword">this</span>._callback) {
        clearTimeout(<span class="hljs-keyword">this</span>._timeout)
        callback()
    }
}

<span class="hljs-built_in">module</span>.exports = Isochronous

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
